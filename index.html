<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>WhatsApp Chat Viewer ‚Äî Simple</title>
<style>
  :root{
    --bg:#0f1115; --fg:#e6e6e6; --muted:#9aa0a6; --bubble1:#1f232b; --bubble2:#16324a;
    --accent:#7aa2f7; --chip:#2a2f3a; --date:#3a3f4a;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font:15px/1.5 system-ui, -apple-system, Segoe UI, Roboto}
  header{position:sticky;top:0;background:rgba(15,17,21,.9);backdrop-filter:saturate(140%) blur(8px);z-index:10;border-bottom:1px solid #21242c}
  .bar{display:flex;gap:.6rem;align-items:center;padding:.8rem .9rem;flex-wrap:wrap}
  .brand{font-weight:700;letter-spacing:.2px;margin-right:auto}
  input[type="file"]{display:none}
  .btn{display:inline-flex;align-items:center;gap:.5rem;border:1px solid #2b2f3a;background:#181b22;padding:.55rem .8rem;border-radius:.6rem;cursor:pointer}
  .btn:hover{border-color:#3a4150}
  .field{display:flex;gap:.5rem;align-items:center;background:#151822;border:1px solid #262a35;border-radius:.6rem;padding:.4rem .6rem}
  .field input{background:transparent;border:0;outline:0;color:var(--fg);min-width:200px}
  .chip{background:var(--chip);border:1px solid #3b4150;padding:.35rem .5rem;border-radius:.5rem;font-size:.85rem}
  .wrap{max-width:980px;margin:0 auto;padding:1rem .9rem 2.5rem}
  .drop{border:1.8px dashed #2f3542;border-radius:.8rem;padding:1rem;text-align:center;color:var(--muted)}
  .drop.drag{border-color:var(--accent);color:var(--accent)}
  .meta{display:flex;gap:.6rem;flex-wrap:wrap;margin-top:.6rem}
  .log{margin-top:1rem;color:var(--muted);font-size:.9rem}
  .date-sep{position:sticky;top:54px;z-index:5;display:inline-block;margin:1.2rem auto .8rem;background:var(--date);color:#cfd3dc;padding:.25rem .6rem;border-radius:1rem;font-size:.8rem}
  .msg{display:flex;gap:.6rem;margin:.25rem 0}
  .msg.me{justify-content:flex-end}
  .bubble{max-width:72ch;padding:.5rem .7rem;border-radius:.7rem;white-space:pre-wrap;word-wrap:break-word}
  .bubble.from1{background:var(--bubble1)}
  .bubble.from2{background:var(--bubble2)}
  .bubble a{color:var(--accent);text-decoration:none}
  .name{font-weight:700;opacity:.92;margin-bottom:.15rem}
  .time{color:var(--muted);font-size:.78rem;margin-top:.18rem}
  .system{display:inline-block;background:#2b2f38;color:#d4d7dd;border:1px solid #3a4150;padding:.35rem .6rem;border-radius:.6rem;font-size:.9rem}
  .footer{margin-top:2rem;color:#808692;font-size:.85rem;text-align:center}
</style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="brand">WA Chat Viewer</div>
      <label class="btn" for="file">üìÑ Buka .txt</label>
      <input id="file" type="file" accept=".txt" />
      <div class="field" title="Cari pesan‚Ä¶">
        üîé <input id="q" placeholder="Search text / nama / kata‚Ä¶" />
      </div>
      <div class="field" title="Loncat ke tanggal (YYYY-MM-DD)">
        üìÖ <input id="goDate" placeholder="YYYY-MM-DD" />
      </div>
      <button class="btn" id="clear">‚ùå clear</button>
      <span id="stats" class="chip">0 pesan</span>
    </div>
  </header>

  <div class="wrap">
    <div id="drop" class="drop">
      <strong>Drag & drop</strong> file <code>_chat.txt</code> di sini atau klik ‚ÄúBuka .txt‚Äù.<br/>
      Support format ekspor WhatsApp umum: <em>‚Äú12/08/2025, 23:55 - Nama: Pesan‚Äù</em>, <em>‚Äú[12/08/25, 23:55] Nama: Pesan‚Äù</em>, dan <em>‚Äú[12/08/25, 23.55.17] Nama: Pesan‚Äù</em>.
    </div>

    <div class="meta" id="meta" style="display:none"></div>
    <div id="list"></div>
    <div id="log" class="log"></div>

    <div class="footer">Made with ‚ù§Ô∏è ‚Äî host di GitHub Pages aja, beres.</div>
  </div>

<script>
(() => {
  const fileInput = document.getElementById('file');
  const drop = document.getElementById('drop');
  const list = document.getElementById('list');
  const q = document.getElementById('q');
  const goDate = document.getElementById('goDate');
  const log = document.getElementById('log');
  const stats = document.getElementById('stats');
  const meta = document.getElementById('meta');
  const clearBtn = document.getElementById('clear');

  let messages = [];   // {ts: Date, dateKey: 'YYYY-MM-DD', time: 'HH:MM', name, text, system}
  let participants = [];
  const nameColor = new Map();

  // Regex pola tanggal WhatsApp yang sering muncul (Android/iOS)
  const patterns = [
    // 1) 12/08/2025, 23:55 - Name: Text
    /^(\d{1,2})[\/\-.](\d{1,2})[\/\-.](\d{2,4}),?\\s+(\\d{1,2}:\\d{2})(?:\\s?(AM|PM))?\\s+[-‚Äì]\\s+([^:]+):\\s([\\s\\S]*)$/,
    // 2) [12/08/25, 23:55] Name: Text
    /^\\[(\\d{1,2})[\\/\\-.](\\d{1,2})[\\/\\-.](\\d{2,4}),?\\s+(\\d{1,2}:\\d{2})(?:\\s?(AM|PM))?\\]\\s([^:]+):\\s([\\s\\S]*)$/,
    // 3) 12/08/2025, 23.55 - Name: Text  (jam pakai titik)
    /^(\\d{1,2})[\\/\\-.](\\d{1,2})[\\/\\-.](\\d{2,4}),?\\s+(\\d{1,2})\\.(\\d{2})(?:\\s?(AM|PM))?\\s+[-‚Äì]\\s+([^:]+):\\s([\\s\\S]*)$/,
    // 4) [12/08/25, 23.55.17] Name: Text  (bracket + detik pakai titik)
    /^\\[(\\d{1,2})[\\/\\-.](\\d{1,2})[\\/\\-.](\\d{2,4}),?\\s+(\\d{1,2})\\.(\\d{2})\\.(\\d{2})(?:\\s?(AM|PM))?\\]\\s([^:]+):\\s([\\s\\S]*)$/,
    // 5) 12/08/2025, 23.55.17 - Name: Text  (tanpa bracket, detik pakai titik)
    /^(\\d{1,2})[\\/\\-.](\\d{1,2})[\\/\\-.](\\d{2,4}),?\\s+(\\d{1,2})\\.(\\d{2})\\.(\\d{2})(?:\\s?(AM|PM))?\\s+[-‚Äì]\\s+([^:]+):\\s([\\s\\S]*)$/,
  ].map(r => new RegExp(r));

  function to24h(hm, ampm){
    // hm: "H:MM"
    let [h, m] = hm.split(':').map(Number);
    if(ampm){
      const ap = ampm.toUpperCase();
      if(ap === 'PM' && h < 12) h += 12;
      if(ap === 'AM' && h === 12) h = 0;
    }
    return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
  }

  function to24hDots(h, m, s, ampm){
    let hh = Number(h), mm = Number(m), ss = Number(s || 0);
    if(ampm){
      const ap = ampm.toUpperCase();
      if(ap === 'PM' && hh < 12) hh += 12;
      if(ap === 'AM' && hh === 12) hh = 0;
    }
    return `${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}`;
  }

  function dmyToISO(d, m, y){
    let yy = String(y);
    if(yy.length === 2) yy = (Number(yy) >= 70 ? '19'+yy : '20'+yy);
    return `${yy}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
  }

  function parse(raw){
    const lines = raw.split(/\\r?\\n/);
    const out = [];
    let current = null;

    for(let i=0;i<lines.length;i++){
      const line = lines[i].trimEnd();
      if(!line){
        if(current) current.text += '\\n';
        continue;
      }

      let matched = false;

      for(let idx=0; idx<patterns.length; idx++){
        const p = patterns[idx];
        const m = line.match(p);
        if(m){
          matched = true;
          if(current) out.push(current);

          if(idx === 0 || idx === 1){
            const d = m[1], mo = m[2], y = m[3], hm = m[4], ap = m[5];
            const name = m[6], text = m[7];
            const time24 = to24h(hm, ap);
            const dateKey = dmyToISO(d, mo, y);
            current = { ts: new Date(`${dateKey}T${time24}`), dateKey, time: time24, name: sanitize(name), text: sanitize(text), system: false };
          } else if (idx === 2){
            const d = m[1], mo = m[2], y = m[3], H = m[4], MM = m[5], ap = m[6];
            const name = m[7], text = m[8];
            const time24 = to24h(`${H}:${MM}`, ap);
            const dateKey = dmyToISO(d, mo, y);
            current = { ts: new Date(`${dateKey}T${time24}`), dateKey, time: time24, name: sanitize(name), text: sanitize(text), system: false };
          } else if (idx === 3 || idx === 4){
            const d = m[1], mo = m[2], y = m[3], H = m[4], MM = m[5], SS = m[6], ap = m[7];
            const name = m[8], text = m[9];
            const time24 = to24hDots(H, MM, SS, ap);
            const dateKey = dmyToISO(d, mo, y);
            current = { ts: new Date(`${dateKey}T${time24}`), dateKey, time: time24, name: sanitize(name), text: sanitize(text), system: false };
          }
          break;
        }
      }

      if(!matched){
        const sys1 = line.match(/^(\\d{1,2})[\\/\\-.](\\d{1,2})[\\/\\-.](\\d{2,4}),?\\s+(\\d{1,2}:\\d{2})(?:\\s?(AM|PM))?\\s+[-‚Äì]\\s+(.+)$/)
                 || line.match(/^\\[(\\d{1,2})[\\/\\-.](\\d{1,2})[\\/\\-.](\\d{2,4}),?\\s+(\\d{1,2}:\\d{2})(?:\\s?(AM|PM))?\\]\\s(.+)$/)
                 || line.match(/^\\[(\\d{1,2})[\\/\\-.](\\d{1,2})[\\/\\-.](\\d{2,4}),?\\s+(\\d{1,2})\\.(\\d{2})\\.(\\d{2})(?:\\s?(AM|PM))?\\]\\s(.+)$/);
        if(sys1){
          if(current) out.push(current);
          const d = sys1[1], mo = sys1[2], y = sys1[3];
          let time24 = '';
          if (sys1[4] && sys1[4].includes(':')) {
            time24 = to24h(sys1[4], sys1[5]);
          } else {
            time24 = to24hDots(sys1[4], sys1[5], sys1[6], sys1[7]);
          }
          const text = sys1[sys1.length-1];
          const dateKey = dmyToISO(d, mo, y);
          current = { ts: new Date(`${dateKey}T${time24}`), dateKey, time: time24, name: '', text: sanitize(text), system: true };
        } else if(current){
          current.text += '\\n' + sanitize(line);
        }
      }
    }
    if(current) out.push(current);
    return out.sort((a,b)=>a.ts - b.ts);
  }

  function sanitize(s){
    return s.replace(/\\t/g,'  ');
  }

  function linkify(s){
    return s.replace(/(https?:\\/\\/[^\\s]+)/g, '<a href="$1" target="_blank" rel="noopener">$1<\\/a>');
  }

  function colorFor(name){
    if(!nameColor.has(name)){
      const idx = nameColor.size % 2;
      nameColor.set(name, idx ? 'from2' : 'from1');
    }
    return nameColor.get(name);
  }

  function escapeHTML(s){
    return s.replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',\"'\":'&#39;'}[c]));
  }

  function render(objs){
    list.innerHTML = '';
    stats.textContent = `${objs.length.toLocaleString('id-ID')} pesan`;
    if(!objs.length){ list.innerHTML = '<div class="log">Tidak ada pesan yang cocok.</div>'; return; }

    let lastDate = '';
    const frag = document.createDocumentFragment();

    objs.forEach(m => {
      if(m.dateKey !== lastDate){
        const sep = document.createElement('div');
        sep.className = 'date-sep';
        sep.textContent = m.dateKey;
        frag.appendChild(sep);
        lastDate = m.dateKey;
      }

      const row = document.createElement('div');
      row.className = 'msg' + (participants.length===2 && m.name && m.name===participants[0] ? ' me':'');

      const bubble = document.createElement('div');
      if(m.system){
        bubble.className = 'system';
        bubble.textContent = m.text;
      } else {
        const cls = colorFor(m.name);
        bubble.className = `bubble ${cls}`;

        // token beautifier
        let renderedText = m.text;
        const low = renderedText.toLowerCase().trim();
        if (low.startsWith('location: http')) {
          const url = renderedText.replace(/^Location:\\s*/i,'').trim();
          renderedText = `üìç <a href="${escapeHTML(url)}" target="_blank" rel="noopener">Location</a>`;
        } else if (low.includes('sticker omitted')) {
          renderedText = 'ü©∑ Sticker';
        } else if (low.includes('image omitted')) {
          renderedText = 'üñºÔ∏è Image';
        } else if (low.includes('video omitted')) {
          renderedText = 'üé• Video';
        } else if (low.includes('audio omitted')) {
          renderedText = 'üéôÔ∏è Audio';
        }

        bubble.innerHTML =
          (m.name ? `<div class="name">${escapeHTML(m.name)}</div>` : '') +
          `<div>${linkify(escapeHTML(renderedText))}</div>` +
          `<div class="time">${m.time}</div>`;
      }

      row.appendChild(bubble);
      frag.appendChild(row);
    });

    list.appendChild(frag);
  }

  function updateMeta(){
    if(!messages.length){ meta.style.display='none'; return; }
    const names = Array.from(new Set(messages.filter(m=>m.name).map(m=>m.name)));
    participants = names;
    meta.style.display='';
    meta.innerHTML = [
      `<span class="chip">Participants: ${names.length ? names.join(', ') : '‚Äî'}</span>`,
      `<span class="chip">Range: ${messages[0].dateKey} ‚Üí ${messages[messages.length-1].dateKey}</span>`
    ].join('');
  }

  function doSearch(){
    const term = q.value.trim().toLowerCase();
    if(!term){ render(messages); return; }
    const filtered = messages.filter(m =>
      (m.name && m.name.toLowerCase().includes(term)) ||
      (m.text && m.text.toLowerCase().includes(term)) ||
      (m.dateKey && m.dateKey.includes(term))
    );
    render(filtered);
  }

  function jumpDate(){
    const key = goDate.value.trim();
    if(!key) return;
    const el = Array.from(list.querySelectorAll('.date-sep')).find(e=>e.textContent===key);
    if(el){ el.scrollIntoView({behavior:'smooth', block:'start'}); el.animate([{opacity:.4},{opacity:1}],{duration:600}); }
  }

  function loadText(text){
    messages = parse(text);
    updateMeta();
    render(messages);
    drop.style.display='none';
    log.textContent = `Loaded ${messages.length.toLocaleString('id-ID')} messages.`;
  }

  // file input
  fileInput.addEventListener('change', e=>{
    const f = e.target.files[0];
    if(!f) return;
    const reader = new FileReader();
    reader.onload = () => loadText(reader.result);
    reader.readAsText(f);
  });

  // drag & drop
  ['dragenter','dragover'].forEach(ev=>{
    drop.addEventListener(ev, e=>{e.preventDefault();e.stopPropagation();drop.classList.add('drag');});
  });
  ['dragleave','drop'].forEach(ev=>{
    drop.addEventListener(ev, e=>{e.preventDefault();e.stopPropagation();drop.classList.remove('drag');});
  });
  drop.addEventListener('drop', e=>{
    const f = e.dataTransfer.files?.[0];
    if(!f) return;
    if(!/\\.txt$/i.test(f.name)) { log.textContent='Hanya file .txt (export tanpa media).'; return; }
    const reader = new FileReader();
    reader.onload = () => loadText(reader.result);
    reader.readAsText(f);
  });

  // search & jump
  q.addEventListener('input', doSearch);
  goDate.addEventListener('keydown', e=>{ if(e.key==='Enter') jumpDate(); });
  clearBtn.addEventListener('click', ()=>{
    q.value=''; goDate.value=''; render(messages);
  });
})();
</script>
</body>
</html>
